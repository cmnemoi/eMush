image: php:7.4

services:
  - postgres:13.1-alpine

variables:
  POSTGRES_DB: emush_test
  POSTGRES_USER: runner
  POSTGRES_PASSWORD: "password"

before_script:
  - php -v
  - apt-get update -yqq
  - apt-get install git zip -yqq zlib1g-dev libpq-dev
  - pecl install xdebug && docker-php-ext-enable xdebug
  - docker-php-ext-configure pgsql -with-pgsql=/usr/local/pgsql && docker-php-ext-install pdo pdo_pgsql pgsql
  - cd Api
  # Install composer
  - curl -sS https://getcomposer.org/installer | php
  # Install all project dependencies
  - php composer.phar install
  - cp .env.gitlab .env

cache:
  paths:
    - "Api/vendor/"

stages:
  - test
  - lint

api-test:
  stage: test
  script:
    - bin/console doctrine:schema:update -f
    - echo y | bin/console doctrine:fixture:load
    - XDEBUG_MODE=coverage php vendor/bin/codecept run --xml --html --coverage
  artifacts:
    when: always
    expire_in: 1 week
    paths:
      - Api/tests/_output
    # make the report available in Gitlab UI. see https://docs.gitlab.com/ee/ci/unit_test_reports.html
    reports:
      junit: Api/tests/_output/report.xml

api-lint:
  stage: lint
  script:
    - ./linters.sh